import{Component}from"@theme/component";import{fetchConfig,debounce,onAnimationEnd,prefersReducedMotion,resetShimmer}from"@theme/utilities";import{morphSection,sectionRenderer}from"@theme/section-renderer";import{ThemeEvents,CartUpdateEvent,DiscountUpdateEvent}from"@theme/events";import{cartPerformance}from"@theme/performance";class CartItemsComponent extends Component{#debouncedOnChange=debounce(this.#onQuantityChange,300).bind(this);connectedCallback(){super.connectedCallback(),document.addEventListener(ThemeEvents.cartUpdate,this.#handleCartUpdate),document.addEventListener(ThemeEvents.discountUpdate,this.handleDiscountUpdate),document.addEventListener(ThemeEvents.quantitySelectorUpdate,this.#debouncedOnChange),this.upselling=JSON.parse(this.dataset.freebies.replace(/'/g,'"')).sort((a,b)=>b.quantities-a.quantities),this.addOns=[47383490265340,47383490101500,47380854178044],this.freeBies(),this.classList.remove("cart-items-disabled")}disconnectedCallback(){super.disconnectedCallback(),document.removeEventListener(ThemeEvents.cartUpdate,this.#handleCartUpdate),document.removeEventListener(ThemeEvents.quantitySelectorUpdate,this.#debouncedOnChange)}#onQuantityChange(event){const{quantity,cartLine:line2}=event.detail;if(!line2)return;if(quantity===0)return this.onLineItemRemove(line2);this.updateQuantity({line:line2,quantity,action:"change"});const lineItemRow=this.refs.cartItemRows[line2-1];if(!lineItemRow)return;lineItemRow.querySelector("text-component")?.shimmer()}onLineItemRemove(line2){this.updateQuantity({line:line2,quantity:0,action:"clear"});const cartItemRowToRemove=this.refs.cartItemRows[line2-1];if(!cartItemRowToRemove)return;[cartItemRowToRemove,...this.refs.cartItemRows.filter(row=>row.dataset.parentKey===cartItemRowToRemove.dataset.key)].forEach(row=>{const remove=()=>row.remove();if(prefersReducedMotion())return remove();row.style.setProperty("--row-height",`${row.clientHeight}px`),row.classList.add("removing"),onAnimationEnd(row,remove)})}updateQuantity(config){const cartPerformaceUpdateMarker=cartPerformance.createStartingMarker(`${config.action}:user-action`);this.#disableCartItems();const{line:line2,quantity}=config,{cartTotal}=this.refs,cartItemsComponents=document.querySelectorAll("cart-items-component"),sectionsToUpdate=new Set([this.sectionId]);cartItemsComponents.forEach(item=>{item instanceof HTMLElement&&item.dataset.sectionId&&sectionsToUpdate.add(item.dataset.sectionId)});const body=JSON.stringify({line:line2,quantity,sections:Array.from(sectionsToUpdate).join(","),sections_url:window.location.pathname});cartTotal?.shimmer(),fetch(`${Theme.routes.cart_change_url}`,fetchConfig("json",{body})).then(response=>response.text()).then(responseText=>{const parsedResponseText=JSON.parse(responseText);if(resetShimmer(this),parsedResponseText.errors){this.#handleCartError(line2,parsedResponseText),this.#enableCartItems();return}const newCartHiddenItemCount=new DOMParser().parseFromString(parsedResponseText.sections[this.sectionId],"text/html").querySelector('[ref="cartItemCount"]')?.textContent,newCartItemCount=newCartHiddenItemCount?parseInt(newCartHiddenItemCount,10):0;this.dispatchEvent(new CartUpdateEvent({},this.sectionId,{itemCount:newCartItemCount,source:"cart-items-component",sections:parsedResponseText.sections})),morphSection(this.sectionId,parsedResponseText.sections[this.sectionId])}).catch(error=>{console.error(error)}).finally(()=>{cartPerformance.measureFromMarker(cartPerformaceUpdateMarker)})}handleDiscountUpdate=event=>{this.#handleCartUpdate(event)};#handleCartError=(line2,parsedResponseText)=>{const quantityInput=this.refs.quantitySelectors[line2-1]?.querySelector("input");if(!quantityInput)throw new Error("Quantity input not found");quantityInput.value=quantityInput.defaultValue;const cartItemError=this.refs[`cartItemError-${line2}`],cartItemErrorContainer=this.refs[`cartItemErrorContainer-${line2}`];if(!(cartItemError instanceof HTMLElement))throw new Error("Cart item error not found");if(!(cartItemErrorContainer instanceof HTMLElement))throw new Error("Cart item error container not found");cartItemError.textContent=parsedResponseText.errors,cartItemErrorContainer.classList.remove("hidden")};#handleCartUpdate=event=>{if(event instanceof DiscountUpdateEvent){this.freeBies("discount-update");return}if(event.target===this){this.freeBies();return}event.detail.data.sections?.[this.sectionId]?this.freeBies():this.freeBies()};#disableCartItems(){this.classList.add("cart-items-disabled")}#enableCartItems(action="no"){this.classList.remove("cart-items-disabled")}freeBies(action="change"){const cartPerformaceUpdateMarker=cartPerformance.createStartingMarker("change:user-action");fetch("/cart.js",{method:"GET"}).then(response=>response.json()).then(response=>{const freeBieExists=response.items.filter(item=>this.upselling.some(bie=>bie.id==item.variant_id)),totalItems=response.items.filter(item=>this.upselling.some(bie=>bie.id==item.variant_id)===!1).filter(item=>!this.addOns.includes(item.variant_id)).reduce((total,item)=>total+=item.quantity,0),inStockProducts=this.upselling.filter(upsell=>upsell.quantities!=0);if(totalItems>2&&freeBieExists.length===0&&inStockProducts.length!==0){const items=[];items.push({id:inStockProducts[0].id,quantity:1}),this.manageFreebies(items,"add");return}if(totalItems<3&&freeBieExists.length!==0){const updates={};freeBieExists.forEach(i=>{updates[i.id]=0}),this.manageFreebies(updates,"remove");return}if(action==="discount-update"){sectionRenderer.renderSection(this.sectionId,{cache:!1}).then(html=>{this.#enableCartItems("yes")});return}sectionRenderer.renderSection(this.sectionId,{cache:!1}).then(html=>{this.#enableCartItems("yes")}),this.#enableCartItems("yes")}).catch(error=>{console.log("Error in getting cart: ",error)}).finally(()=>{cartPerformance.measureFromMarker(cartPerformaceUpdateMarker)})}manageFreebies(data,actionType,action="change"){const cartPerformaceUpdateMarker=cartPerformance.createStartingMarker(`${action}:user-action`);this.#disableCartItems();const{cartTotal}=this.refs,cartItemsComponents=document.querySelectorAll("cart-items-component"),sectionsToUpdate=new Set([this.sectionId]);cartItemsComponents.forEach(item=>{item instanceof HTMLElement&&item.dataset.sectionId&&sectionsToUpdate.add(item.dataset.sectionId)});const payload={sections:Array.from(sectionsToUpdate).join(","),sections_url:window.location.pathname};actionType==="add"&&(payload.items=data),actionType==="remove"&&(payload.updates=data);const body=JSON.stringify(payload);cartTotal?.shimmer(),fetch(`${actionType==="add"?Theme.routes.cart_add_url:Theme.routes.cart_update_url}`,fetchConfig("json",{body})).then(response=>response.text()).then(responseText=>{const parsedResponseText=JSON.parse(responseText);if(resetShimmer(this),parsedResponseText.errors){this.#handleCartError(line,parsedResponseText),this.#enableCartItems();return}const newCartHiddenItemCount=new DOMParser().parseFromString(parsedResponseText.sections[this.sectionId],"text/html").querySelector('[ref="cartItemCount"]')?.textContent,newCartItemCount=newCartHiddenItemCount?parseInt(newCartHiddenItemCount,10):0;this.dispatchEvent(new CartUpdateEvent({},this.sectionId,{itemCount:newCartItemCount,source:"cart-items-component",sections:parsedResponseText.sections})),morphSection(this.sectionId,parsedResponseText.sections[this.sectionId])}).catch(error=>{console.error(error)}).finally(()=>{this.#enableCartItems("1"),cartPerformance.measureFromMarker(cartPerformaceUpdateMarker)})}get sectionId(){const{sectionId}=this.dataset;if(!sectionId)throw new Error("Section id missing");return sectionId}}customElements.get("cart-items-component")||customElements.define("cart-items-component",CartItemsComponent);
//# sourceMappingURL=/cdn/shop/t/196/assets/component-cart-items.js.map?v=108386128647065240881770880882
